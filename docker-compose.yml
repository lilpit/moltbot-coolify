# ============================================================================
# OpenClaw (Clawdbot) Docker Compose for Coolify
# ============================================================================
# 
# Deploy in Coolify:
# 1. Create a new "Docker Compose" service
# 2. Point to this repository or upload these files
# 3. Configure environment variables in Coolify UI
# 4. Deploy!
#
# ============================================================================

services:
  # -------------------------------------------------------------------------
  # Main Gateway Service
  # -------------------------------------------------------------------------
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        OPENCLAW_VERSION: ${OPENCLAW_VERSION:-latest}
        EXTRA_APT_PACKAGES: ${EXTRA_APT_PACKAGES:-}
        INSTALL_CLAUDE_CODE: ${INSTALL_CLAUDE_CODE:-true}
    container_name: openclaw-gateway
    hostname: openclaw
    restart: unless-stopped
    
    # Expose ports
    ports:
      - "${GATEWAY_PORT:-18789}:18789"
      - "9117:9117"
    
    # Environment variables - configure in Coolify UI
    environment:
      # Gateway Configuration
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - GATEWAY_PORT=${GATEWAY_PORT:-18789}
      - GATEWAY_VERBOSE=${GATEWAY_VERBOSE:-false}

      # Model Provider API Keys (at least one required)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

      # Model Selection
      - OPENCLAW_MODEL=${OPENCLAW_MODEL:-anthropic/claude-sonnet-4-5}
      
      # Channel Tokens (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}
      
      # Feature Toggles
      - ENABLE_BROWSER=${ENABLE_BROWSER:-false}
      - ENABLE_SANDBOX=${ENABLE_SANDBOX:-false}
      
      # Node environment
      - NODE_ENV=production
      - HOME=/home/node
    
    # Persistent volumes
    volumes:
      # Legacy clawdbot configuration (preserved for backward compatibility)
      - moltbot-config:/home/node/.clawdbot
      # New OpenClaw configuration and credentials
      - openclaw-config:/home/node/.openclaw
      # Agent workspace (persisted from moltbot)
      - moltbot-workspace:/home/node/clawd
      # Claude credentials for Claude Code automation (persisted from moltbot)
      - moltbot-claude:/home/node/.claude
      # Optional: mount host directories for file access
      # - ${HOST_DATA_PATH:-./data}:/home/node/data:rw
    
    # Resource limits (adjust based on your Coolify plan)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Health check
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Labels for Coolify/Traefik integration
    labels:
      - "coolify.managed=true"
      - "coolify.name=openclaw"
      - "traefik.enable=true"
      # Service definition
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      # WebSocket support middleware
      - "traefik.http.middlewares.openclaw-ws.headers.customrequestheaders.Connection=Upgrade"
      - "traefik.http.middlewares.openclaw-ws.headers.customrequestheaders.Upgrade=websocket"
      # HTTP router (no TLS, accepts any host)
      - "traefik.http.routers.openclaw-http.rule=PathPrefix(`/`)"
      - "traefik.http.routers.openclaw-http.entrypoints=http"
      - "traefik.http.routers.openclaw-http.service=openclaw"
      - "traefik.http.routers.openclaw-http.middlewares=openclaw-ws"
      # HTTPS router (with TLS, domain-based)
      - "traefik.http.routers.openclaw.rule=Host(`${DOMAIN:-openclaw.localhost}`)"
      - "traefik.http.routers.openclaw.entrypoints=websecure"
      - "traefik.http.routers.openclaw.tls.certresolver=letsencrypt"
      - "traefik.http.routers.openclaw.service=openclaw"
      - "traefik.http.routers.openclaw.middlewares=openclaw-ws"

  # -------------------------------------------------------------------------
  # CLI Service (for running commands)
  # -------------------------------------------------------------------------
  openclaw-cli:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        OPENCLAW_VERSION: ${OPENCLAW_VERSION:-latest}
    container_name: openclaw-cli
    profiles:
      - cli

    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NODE_ENV=production
      - HOME=/home/node

    volumes:
      # Legacy clawdbot configuration (preserved for backward compatibility)
      - moltbot-config:/home/node/.clawdbot
      # New OpenClaw configuration and credentials
      - openclaw-config:/home/node/.openclaw
      - moltbot-workspace:/home/node/clawd
      - moltbot-claude:/home/node/.claude

    # Override entrypoint for CLI usage
    entrypoint: ["openclaw"]
    command: ["--help"]

    # Connect to gateway network
    network_mode: "service:openclaw-gateway"

# ============================================================================
# Named Volumes (persisted from moltbot for data continuity)
# ============================================================================
volumes:
  moltbot-config:
    name: moltbot-config
    labels:
      - "coolify.volume=true"
      - "description=Legacy Clawdbot configuration (backward compatibility)"

  openclaw-config:
    name: openclaw-config
    labels:
      - "coolify.volume=true"
      - "description=OpenClaw configuration and credentials"

  moltbot-workspace:
    name: moltbot-workspace
    labels:
      - "coolify.volume=true"
      - "description=OpenClaw agent workspace (persisted)"

  moltbot-claude:
    name: moltbot-claude
    labels:
      - "coolify.volume=true"
      - "description=Claude Code credentials (persisted)"

# ============================================================================
# Networks (optional, Coolify manages this automatically)
# ============================================================================
networks:
  default:
    name: openclaw-network
